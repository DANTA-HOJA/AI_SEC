# Instructions for Data Preprocessing

## Notifications (Before running any commands in the following sections)

1. Ensure that you are in the ***Python environment*** configured for this repository.
2. Confirm that your ***current working directory*** is the root of this repository.

     - In a terminal emulator, if no command has been entered, the directory shown before the cursor indicates the ***current working directory***.
     - To change the ***current working directory***, use the `cd` command to navigate to the desired directory.

3. The sections annotated with ***Included in the deposited data*** mean that you can skip those sections, as the results are already available in the [data][data_repo].

## Data Structure

After completing all the following tutorials, a ***qualified data instance*** should look like this:

```text
ğŸ“‚ {Data}_Processed/ (â—€ï¸ Specified in `db_path_plan.toml`)
â”‚
â”œâ”€â”€ ğŸ“‚ {`note`}_Academia_Sinica_i[Num]/ (â—€ï¸ Referred to as 'data instance')
â”‚   â”œâ”€â”€ ğŸ“‚ {`bf_param_note`}_BrightField_analyze/
â”‚   â”œâ”€â”€ ğŸ“‚ {`bf_param_note`}_BrightField_reCollection/ (â—€ï¸ Optional)
â”‚   â”œâ”€â”€ ğŸ“‚ {`palmskin_param_note`}_PalmSkin_preprocess/
â”‚   â”œâ”€â”€ ğŸ“‚ {`palmskin_param_note`}_PalmSkin_reCollection/ (â—€ï¸ Optional)
â”‚   â”œâ”€â”€ ğŸ“‚ Clustered_File/
â”‚   â”œâ”€â”€ ğŸ“„ data.csv
â”‚   â”œâ”€â”€ ğŸ“„ datasplit_[`RND`].csv
â”‚   â””â”€â”€ ğŸ“„ split_count.log
```

## Palmskin Image (Per Image) (scripts `0.2.1`)

- ***Included in the deposited data***

### 1. Converting 3D `LIF` to 2D `TIFF`

| **Script** | **Config** |
|--------|--------|
| [`0.2.1.preprocess_palmskin.py`][SCRIPT-0.2.1] | [`Config/0.2.1.preprocess_palmskin.toml`][TOML-0.2.1] |

1. Open the [`0.2.1.preprocess_palmskin.toml`][TOML-0.2.1] and set the desired parameters. For details, please refer to the [example file][EXAMPLE_CONFIG-0.2.1].
2. Run the following command:

    ```shell
    cd script_data/
    python 0.2.1.preprocess_palmskin.py
    ```

3. The results are structured as follows:

    ```text
    ğŸ“‚ {Data}_Processed/
    â”‚
    â”œâ”€â”€ ğŸ“‚ {`note`}_Academia_Sinica_i[Num]/
    â”‚   â”‚
    â”‚   â”œâ”€â”€ ğŸ“‚ {`palmskin_param_note`}_PalmSkin_preprocess/
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ 20220610_CE001_palmskin_8dpf - Series001_fish_1_A_RGB/
    â”‚   â”‚   â”‚   â”‚ (ğŸ”¼ Referred to as `fish_dname`, abbr. of 'fish data name')
    â”‚   â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ 03_RGB_direct_max_zproj.tif (â­)
    â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ ...
    â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“‚ MetaImage/
    â”‚   â”‚   â”‚       â””â”€â”€ ğŸ–¼ï¸ ...
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ 20220610_CE001_palmskin_8dpf - Series002_fish_1_P_RGB/
    â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ 20220610_CE001_palmskin_8dpf - Series003_fish_2_A_RGB/
    â”‚   â”‚   â””â”€â”€ ğŸ“‚ ...
    ```

    > Note: You may see many variants of images in a single `fish_dname` directory, but we only focus on `03_RGB_direct_max_zproj.tif`, which is generated by applying a maximum projection without any further image processing.

## Bright-field Image (Per Fish)  (scripts `0.3.x`)

- ***Included in the deposited data***

### 1. Cropping and Converting from 16-bit to 8-bit Image

| **Script** | **Config** |
|--------|--------|
| [`0.3.1.analyze_brightfield.py`][SCRIPT-0.3.1] | [`Config/0.3.1.analyze_brightfield.toml`][TOML-0.3.1] |

0. Install the `Fiji (ImageJ)` plugin [`Find Focused Slices`](https://sites.google.com/site/qingzongtseng/find-focus)

   1. Download the plugin file [`Find_focused_slices.class`](https://github.com/qztseng/imagej_plugins/raw/master/current/Find_focused_slices.class)
   2. Place it into the `plugins` folder of your `Fiji (ImageJ)` installation directory:

        ```text
        ğŸ“‚ Fiji.app/
        â”œâ”€â”€ ğŸ“‚ ...
        â”œâ”€â”€ ğŸ“‚ plugins/
        â”‚   â”œâ”€â”€ ğŸ“‚ ...
        â”‚   â”œâ”€â”€ ğŸ“„ Find_focused_slices.class (â—€ï¸ Place the file here )
        â”‚   â””â”€â”€ ğŸ“„ ...
        â””â”€â”€ ...
        ```

1. Open the [`0.3.1.analyze_brightfield.toml`][TOML-0.3.1] and set the desired parameters. For details, please refer to the [example file][EXAMPLE_CONFIG-0.3.1].
2. Run the following command:

    ```shell
    cd script_data/
    python 0.3.1.analyze_brightfield.py
    ```

3. The results are structured as follows:

    ```text
    ğŸ“‚ {Data}_Processed/
    â”‚
    â”œâ”€â”€ ğŸ“‚ {`note`}_Academia_Sinica_i[Num]/
    â”‚   â”‚
    â”‚   â”œâ”€â”€ ğŸ“‚ {`bf_param_note`}_BrightField_analyze/
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ 20220610_CE001_palmskin_8dpf - Series001_fish_1_BF/
    â”‚   â”‚   â”‚   â”‚ (ğŸ”¼ Referred to as `fish_dname`, abbr. of 'fish data name')
    â”‚   â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ 02_cropped_BF.tif (â­)
    â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ManualAnalysis.csv (â—€ï¸ Only for fish IDs 1 to 255 )
    â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ Manual_measured_mask.tif (â—€ï¸ Only for fish IDs 1 to 255 )
    â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ Manual_cropped_BF--MIX.tif (â—€ï¸ Only for fish IDs 1 to 255 )
    â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ...
    â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ ...
    â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“‚ MetaImage/
    â”‚   â”‚   â”‚       â””â”€â”€ ğŸ–¼ï¸ ...
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ 20220610_CE001_palmskin_8dpf - Series003_fish_2_BF/
    â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ 20220610_CE001_palmskin_8dpf - Series003_fish_3_BF/
    â”‚   â”‚   â””â”€â”€ ğŸ“‚ ...
    ```

    > Note: You may see many variants of images in a single `fish_dname` directory, but we only focus on `02_cropped_BF.tif`, which serves as the image for manual segmentation and Res18-Unet automated segmentation. Only fish IDs 1 to 255 include manual segmentation, which is used to train the Res18-Unet model (described in the next section).

### 2. Res18-Unet Automated Segmentation

- For details, please refer to [`script_bfseg/`](../script_bfseg/)
- After the automated segmentation, two new images are added to each `fish_dname` directory:

    ```text
    ğŸ“‚ 20220610_CE001_palmskin_8dpf - Series001_fish_1_BF/
    â”‚
    â”œâ”€â”€ ğŸ–¼ï¸ 02_cropped_BF.tif
    â”œâ”€â”€ ğŸ–¼ï¸ UNet_predict_mask.tif (â—€ï¸ New image )
    â”œâ”€â”€ ğŸ–¼ï¸ UNet_cropped_BF--MIX.tif (â—€ï¸ New image )
    â”œâ”€â”€ ğŸ“„ ...
    â”œâ”€â”€ ğŸ–¼ï¸ ...
    â””â”€â”€ ğŸ“‚ MetaImage/
        â””â”€â”€ ğŸ–¼ï¸ ...
    ```

    > Note: Segmentation results may ***NOT*** be consistent on different computers due to variations in hardware, such as differences in GPU or CPU architectures, floating-point precision, and computation libraries, as well as non-deterministic operations in deep learning frameworks.

### 3. Obtaining the standard length and trunk surface area

| **Script** | **Config** |
|--------|--------|
| [`0.3.2.measure_unet_area.py`][SCRIPT-0.3.2] | [`Config/0.3.1.analyze_brightfield.toml`][TOML-0.3.1] |

1. Open the [`0.3.1.analyze_brightfield.toml`][TOML-0.3.1] and set the desired parameters. For details, please refer to the [example file][EXAMPLE_CONFIG-0.3.1].
2. Run the following command:

    ```shell
    cd script_data/
    python 0.3.2.measure_unet_area.py
    ```

3. A measurement file is added to each `fish_dname` directory:

    ```text
    ğŸ“‚ 20220610_CE001_palmskin_8dpf - Series001_fish_1_BF/
    â”‚
    â”œâ”€â”€ ğŸ–¼ï¸ 02_cropped_BF.tif
    â”œâ”€â”€ ğŸ“„ UNetAnalysis.csv (â—€ï¸ Measurement file )
    â”œâ”€â”€ ğŸ–¼ï¸ UNet_predict_mask.tif
    â”œâ”€â”€ ğŸ–¼ï¸ UNet_cropped_BF--MIX.tif
    â”œâ”€â”€ ğŸ“„ ...
    â”œâ”€â”€ ğŸ–¼ï¸ ...
    â””â”€â”€ ğŸ“‚ MetaImage/
        â””â”€â”€ ğŸ–¼ï¸ ...
    ```

## (Optional) File Collector (script `0.4.1`)

The file structure is based on fish IDs, which makes it difficult to view a specific type of result at the same time. To address this issue, this script will automatically collect the specified results and rename them using the corresponding fish IDs.

| **Script** | **Config** |
|--------|--------|
| [`0.4.1.collect_results.py`][SCRIPT-0.4.1] | [`Config/0.4.1.collect_results.toml`][TOML-0.4.1] |

1. Open the [`0.4.1.collect_results.toml`][TOML-0.4.1] and set the desired parameters. For details, please refer to the [example file][EXAMPLE_CONFIG-0.4.1].
2. Run the following command:

    ```shell
    cd script_data/
    python 0.4.1.collect_results.py
    ```

3. The results are structured as follows:

    ```text
    ğŸ“‚ {Data}_Processed/
    â”‚
    â”œâ”€â”€ ğŸ“‚ {`note`}_Academia_Sinica_i[Num]/
    â”‚   â”‚
    â”‚   â”œâ”€â”€ ğŸ“‚ {`palmskin_param_note`}_PalmSkin_reCollection/
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ 03_RGB_direct_max_zproj/ (â—€ï¸ The specified result )
    â”‚   â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ 20220610_CE001_palmskin_8dpf - Series001_fish_1_A_RGB.tif
    â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ 20220610_CE001_palmskin_8dpf - Series002_fish_1_P_RGB.tif
    â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ 20220610_CE001_palmskin_8dpf - Series003_fish_2_A_RGB.tif
    â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ–¼ï¸ ...
    â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ {Logs}_collect_palmskin_results.log
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€ ğŸ“‚ ...
    ```

## Clustered File (scripts `0.5.x`)

### 1. Create `data.csv`

This script will automatically scan the measurement file and create a `CSV` file.


```text
columns:

Brightfield
Analysis Mode
Palmskin Anterior (SP8)
Palmskin Posterior (SP8)
"Trunk surface area, SA (um2)"
"Standard Length, SL (um)"
```

### 2. Split train/valid/test

```text
1. How to create
2. where to save
```

### 3. Generate size label (clustering)

```text
1. How to create
2. where to save
```

## Rescaled Bright-field to a Uniform Size (script `0.6.1`)

```text
1. How to create
2. where to save
```

## Configuration Settings Examples (*.toml)

```text
A series of .ipynb notebooks to demonstrate the valid inputs for configurations.
...
```

<!-- Hyperlinks -->
[data_repo]: https://data_repo

[SCRIPT-0.2.1]: 0.2.1.preprocess_palmskin.py
[TOML-0.2.1]: Config/0.2.1.preprocess_palmskin.toml
[EXAMPLE_CONFIG-0.2.1]: docs/examples/config_data

[SCRIPT-0.3.1]: 0.3.1.analyze_brightfield.py
[TOML-0.3.1]: Config/0.3.1.analyze_brightfield.toml
[EXAMPLE_CONFIG-0.3.1]: docs/examples/config_data

[SCRIPT-0.3.2]: 0.3.2.measure_unet_area.py

[SCRIPT-0.4.1]: 0.4.1.collect_results.py
[TOML-0.4.1]: Config/0.4.1.collect_results.toml
[EXAMPLE_CONFIG-0.4.1]: docs/examples/config_data
